---
title: "Land use land cover change due to green extractivism in Mozambique"
author: "Emilinah Namaganda"
date: "7/18/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the necessary libraries

```{r }

library(terra) # raster data
library(sf) # vector data
library(lintr) #organize writing style
library(rpart) # train classification model
library(dismo) # model evaluation
library(ggplot2)
library(reshape2) #converting dataframe to long format for ggplot



```

## Preprocessing Balama images

```{r}

# loading relevant image bands -----------


bands17 <- function(images) {
  bands17 <- list.files(images,
    pattern = glob2rx("*B*"),
    full.names = TRUE
  )
  bands17 <- rast(bands17[1:7])
  return(bands17)
}

blma2021_b17 <- bands17("~/data/raw/images/2021/0609")


# removing cloud cover pixels, re-projecting to correct CRS, crop to AOI ------

moz_crs    <- "+init=EPSG:32737"
blma       <- st_read("~/data/raw/balama/blma.shp", query = "SELECT POSTO FROM \"blma\"")
syrah      <- st_read("~/data/raw/balama/syrah.shp",
  query = "SELECT Mine FROM \"syrah\" WHERE FID = 0")
syrah_buf  <- st_buffer(syrah, 9000)

ggplot() +
  geom_sf(data = blma) + 
  geom_sf(data = syrah_buf) +
  geom_sf(data = syrah) +
  coord_sf()


blma2021_qa            <- rast(
  "~/data/raw/images/2021/0609/LC08_L2SP_165069_20210609_20210615_02_T1_QA_PIXEL.TIF") 
# check how to decode qa band in QGIS (open source).
activeCat(blma2021_qa) <- 0
plot(blma2021_qa)


aoi             <- function(QAband, bands17, mineArea) {
  cloudmask     <- classify(QAband, rbind(c(21824, 21824), c(21952, 21952)),
                         others = NULL)
  b17_clear     <- mask(bands17, cloudmask)
  b17_clearProj <- project(b17_clear, moz_crs)
  aoi_mineArea  <- crop(b17_clearProj, mineArea, snap = "near", mask = TRUE)
  return(aoi_mineArea)
}


blma2021        <- aoi(blma2021_qa, blma2021_b17, syrah_buf)
names(blma2021) <- gsub(
  pattern = "LC08_L2SP_165069_20210609_20210615_02_T1_SR",
  replacement = "blma2021",
  names(blma2021))

```

## Classifying Balama 2021 image

```{r}

# composites and indices exported to arcgis to create training samples. 
# couldn't find how to do that in R. Perhaps additional benefit of GEE is that
# it is more self-contained?

par(mfrow = c(2, 2))

comps   <- function(bands17, x, y, z) {
  comps <-c(bands17[[x]], bands17[[y]], bands17[[z]])
  return(comps)
}


blma2021_b543 <- comps(blma2021, 5, 4, 3)
writeRaster(blma2021_b543, file.path("~/results/output", "blma2021_b543.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_b654 <- comps(blma2021, 6, 5, 4)
writeRaster(blma2021_b654, file.path("~/results/output", "blma2021_b654.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_b432 <- comps(blma2021, 4, 3, 2)
writeRaster(blma2021_b432, file.path("~/results/output", "blma2021_b432.tif"),
            overwrite=TRUE, filetype="GTiff")

plotRGB(blma2021_b543, r = 1, g = 2, b = 3, stretch = "lin")
plot(syrah, add = TRUE)


indices <- function(bands17, x, y) {
  bandx <- bands17[[x]]
  bandy <- bands17[[y]]
  indices <- (bandx - bandy)/(bandx + bandy)
  return(indices)
}


blma2021_ndvi <- indices(blma2021, 5, 4)
writeRaster(blma2021_ndvi, file.path("~/results/output", "blma2021_ndvi.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_ndbi <- indices(blma2021, 6, 5)
writeRaster(blma2021_ndbi, file.path("~/results/output", "blma2021_ndbi.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_mndwi <- indices(blma2021, 3, 6)
writeRaster(blma2021_mndwi, file.path("~/results/output", "blma2021_mndwi.tif"),
            overwrite=TRUE, filetype="GTiff")

plot(blma2021_ndvi)
plot(syrah, add = TRUE)

## model training

blma2021_train <- vect("~/data/temp/training-samples/blma2021_b543_train.shp")

# create training samples from ground truth training sites data

samps <- function(train, aoi) {
  Tsamps  <- spatSample(train, 500, method = "random")
  sampsXY <- as.matrix(geom(Tsamps)[,c('x','y')])
  sampsdf <- extract(aoi, sampsXY)
  samps   <- data.frame(class = Tsamps$Classname, sampsdf)
  return(samps)
}


blma2021_samps     <- samps(blma2021_train, blma2021)
blma2021_sampsDist
blma2021_sampsDist <- table(as.character(blma2021_samps$class))
write.table(blma2021_sampsDist, 
            file.path("~/results/output", "blma2021_sampsDist.csv"))

# inspect the spectral profiles of the training samples

col4 <- c('darkorange', 'darkgreen', 'green', 'deepskyblue')
col5 <- c('darkorange', 'darkgreen', 'green', 'deepskyblue', 'lightcyan')


sampsSP <- function(samps) {
  sampsSP             <- aggregate(samps[, -1], list(samps$class), mean)
  rownames(sampsSP)   <- sampsSP[, 1]
  sampsSP             <- sampsSP[, -1]
  names(sampsSP)[1:7] <- 1:7
  sampsSP             <- t(sampsSP)
  sampsSP             <- as.data.frame(sampsSP)
  sampsSP             <- cbind(bands = rownames(sampsSP), sampsSP)
  rownames(sampsSP)   <- NULL
  sampsSP             <- melt(sampsSP, id.vars = "bands", variable.name = "lulc")
  sampsSP$bands       <- as.numeric(sampsSP$bands)
  sampsSP             <- ggplot(sampsSP, aes(bands, value)) +
    geom_line(aes(color = lulc), size = 1) +
    ggtitle("Spectral Profiles") +
    labs(x = "Bands", y = "Reflectance") +
    scale_colour_manual("LULC", 
                    values = col4,
                    labels = clas4)
  return(sampsSP)
}
sampsSP(blma2021_samps)

# create training model and classify image

lulc <- function(samps, aoi) {
  model      <- rpart(as.factor(class)~., data = samps, 
                         method = 'class', minsplit = 5)
  classified <- predict(aoi, model, na.rm = TRUE)
  lulc       <- which.max(classified)
  return(lulc)
}

blma2021_lulc           <- lulc(blma2021_samps, blma2021)
blma2021_lulc

# plotting classified image

blma2021_lulcdf         <- blma2021_lulc
lulc_df                 <- data.frame(id = 1:4, lulc = clas4)
levels(blma2021_lulcdf) <- lulc_df
blma2021_lulcdf         <- as.data.frame(blma2021_lulcdf, xy = TRUE)

clas4 <- c("built & bare", "dense vegetation", "sparse vegetation", "water")
clas5 <- c("built & bare", "dense vegetation", "sparse vegetation", "water", "wetland")

ggplot() +
  geom_raster(data = blma2021_lulcdf, aes(x = x, y = y, fill = lulc)) +
  geom_sf(data = syrah, fill = NA) +
  labs(x = NULL, 
       y = NULL, 
       title = "Balama 2021 land use land cover") +
  scale_fill_manual("LULC", 
                    values = col4,
                    labels = clas4) +
  coord_sf()


# model evaluation

sampGrps   <- kfold(blma2021_samps, k = 5, by = blma2021_samps$class)
table(sampGrps)
accuracies <- list()

for (k in 1:5) {
  train      <- blma2021_samps[sampGrps!= k, ]
  test       <- blma2021_samps[sampGrps == k, ]
  model      <- rpart(as.factor(class)~., data=train, method = 'class', minsplit = 5) # TODO check minsplit value.
  classified <- predict(model, test, na.rm = TRUE) 
  lulc       <- apply(classified, 1, which.max)
  accuracies[[k]] <- cbind(test$class, as.integer(lulc))
}
accuracies

# lulc accuracy assessment

lulc_acc <- function(acc) {
  acctidy            <- do.call(rbind, accuracies)
  acctidy            <- data.frame(acctidy)
  colnames(acctidy)  <- c('observed', 'predicted')
  confmat            <- table(acctidy)
  colnames(confmat)  <- lulc_df$class
  samples            <- sum(confmat)
  samples_true       <- diag(confmat)
  overallAcc         <- sum(samples_true)/samples
  obsCases           <- apply(confmat, 1, sum)
  obsCases_true      <- obsCases/samples
  predCases          <- apply(confmat, 2, sum)
  predCases_true     <- predCases/samples
  expAcc             <- sum(obsCases_true*predCases_true)
  kappa              <- (overallAcc - expAcc)/(1 - expAcc)
  ProdAcc            <- samples_true/predCases
  UserAcc            <- samples_true/obsCases
  outAcc             <- data.frame(ProdAcc, UserAcc)
  lulc_acc           <- list(confmat, overallAcc, kappa, outAcc)
  return(lulc_acc)
}

blma2021_lulcAcc <- lulc_acc(accuracies)
blma2021_lulcAcc

# i know for sure built-bare is currently wrongly classified as sparse veg.
# see GEE script from Simon.
```

## change detection

Note that the `echo = FALSE` parameter was added to the code chunk to prevent
printing of the R code that generated the plot.
