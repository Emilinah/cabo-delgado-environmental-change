---
title: "Land use land cover change due to green extractivism in Mozambique"
author: "Emilinah Namaganda"
date: "7/18/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the necessary libraries

```{r }

library(terra) # raster data
library(sf) # vector data
library("lintr") #organize writing style
library(rpart) # train classification model
library(dismo) # model evaluation

```

## Preprocessing Balama images 2021

```{r}

# loading relevant image bands -----------


bands17 <- function(images_path) {
  bands17 <- list.files(images_path,
    pattern = glob2rx("*B*"),
    full.names = TRUE
  )
  bands17 <- rast(bands17[1:7])
  return(bands17)
}

blma2021_b17 <- bands17("~/data/raw/images/2021/0609")
blma2021_b17


# removing cloud cover pixels, re-projecting to correct CRS, crop to AOI ------

moz_crs <- "+init=EPSG:32737"
blma <- vect(
  x = "~/data/raw/balama/blma.shp",
  query = "SELECT POSTO FROM \"blma\""
)
syrah <- vect(
  x = "~/data/raw/balama/syrah.shp",
  query = "SELECT Mine FROM \"syrah\" WHERE FID = 0"
)
syrah_buf <- buffer(syrah, 9000)


blma2021_qa <- rast(
  "~/data/raw/images/2021/0609/LC08_L2SP_165069_20210609_20210615_02_T1_QA_PIXEL.TIF"
) # check how to decode qa band in QGIS (open source).
activeCat(blma2021_qa) <- 0
plot(blma2021_qa)


aoi <- function(QA_band, bands_17, mine_area) {
  cloudsmask <- classify(QA_band, rbind(c(21824, 21824), c(21952, 21952)),
                         others = NULL)
  b17_clear <- mask(bands_17, cloudsmask)
  b17_clear_proj <- project(b17_clear, moz_crs)
  aoi_mine_area <- crop(b17_clear_proj, mine_area, snap = "near", mask = TRUE)
  return(aoi_mine_area)
}


blma2021 <- aoi(blma2021_qa, blma2021_b17, syrah_buf)
names(blma2021) <- gsub(
  pattern = "LC08_L2SP_165069_20210609_20210615_02_T1_SR",
  replacement = "blma2021",
  names(blma2021))

plot(blma2021$blma2021_B4)
plot(syrah, add = TRUE)

```

## Classifying Balama 2021 image

```{r}

# composites and indices exported to arcgis to create training samples. 
# couldn't find how to do that in R. Perhaps additional benefit of GEE is that
# it is more self-contained?

par(mfrow = c(2, 2))

aoi_comps <- function(bands_17, x, y, z) {
  aoi_comp <-c(bands_17[[x]], bands_17[[y]], bands_17[[z]])
  return(aoi_comp)
}

blma2021_b543 <- aoi_comps(blma2021, 5, 4, 3)
writeRaster(blma2021_b543, file.path("~/results/output", "blma2021_b543.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_b654 <- aoi_comps(blma2021, 6, 5, 4)
writeRaster(blma2021_b654, file.path("~/results/output", "blma2021_b654.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_b432 <- aoi_comps(blma2021, 4, 3, 2)
writeRaster(blma2021_b432, file.path("~/results/output", "blma2021_b432.tif"),
            overwrite=TRUE, filetype="GTiff")

plotRGB(blma2021_b543, r = 1, g = 2, b = 3, stretch = "lin")
plot(syrah, add = TRUE)


aoi_index <- function(bands_17, x, y) {
  band_x <- bands_17[[x]]
  band_y <- bands_17[[y]]
  index <- (band_x - band_y)/(band_x + band_y)
  return(index)
}

blma2021_ndvi <- aoi_index(blma2021, 5, 4)
writeRaster(blma2021_ndvi, file.path("~/results/output", "blma2021_ndvi.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_ndbi <- aoi_index(blma2021, 6, 5)
writeRaster(blma2021_ndbi, file.path("~/results/output", "blma2021_ndbi.tif"),
            overwrite=TRUE, filetype="GTiff")

blma2021_mndwi <- aoi_index(blma2021, 3, 6)
writeRaster(blma2021_mndwi, file.path("~/results/output", "blma2021_mndwi.tif"),
            overwrite=TRUE, filetype="GTiff")

plot(blma2021_ndvi)
plot(syrah, add = TRUE)

# model training

blma2021_train <- vect("~/data/temp/training-samples/blma2021_b543_train.shp")
plot(blma2021_train)
plot(syrah_buf, add=TRUE)
text(blma2021_train, blma2021_train$Classname)

set.seed(1)
blma2021_train_samps <- spatSample(blma2021_train, 200, method = "regular")
blma2021_train_samps_df <- extract(blma2021_b543, blma2021_train_samps)
head(blma2021_train_samps_df)

blma2021_train_samps_df_mean <- aggregate(blma2021_train_samps_df[, -1], list(blma2021_train_samps$Classname), mean)
rownames(blma2021_train_samps_df_mean) <- blma2021_train_samps_df_mean[, 1]
blma2021_train_samps_df_mean <- blma2021_train_samps_df_mean[, -1]

blma2021_train_samps_df_mean

lulc_colors_5 <- c('darkorange', 'darkgreen', 'green', 'deepskyblue', 'lightcyan')
lulc_colors_4 <- c('darkorange', 'darkgreen', 'green', 'deepskyblue')


blma2021_train_samps_df_mean <- as.matrix(blma2021_train_samps_df_mean)
blma2021_train_samps_df_mean

plot(7400, ylim=c(7400,18000), xlim = c(1,3), type='n', xlab="Bands", ylab = "Reflectance")

for (i in 1:nrow(blma2021_train_samps_df_mean)){
lines(blma2021_train_samps_df_mean[i,], type = "l", lwd = 3, lty = 1, col = lulc_colors_4[i])
}

title(main="Spectral Signatures", font.main = 2)

legend("topright", rownames(blma2021_train_samps_df_mean),
cex=0.8, col=lulc_colors_4, lty = 1, lwd =3, bty = "n")

set.seed(1)
blma2021_samps <- spatSample(blma2021_train, 500, method = "random")
plot(blma2021_samps, "Classname")
table(as.character(blma2021_samps$Classname))

plotRGB(blma2021_b543, r = 1, b = 2, g = 3, stretch = "lin")
points(blma2021_samps)

blma2021_samps_xy <- as.matrix(geom(blma2021_samps)[,c('x','y')])
blma2021_samps_df <- extract(blma2021_b543, blma2021_samps_xy)

blma2021_samps_final <- data.frame(class = blma2021_samps$Classname, blma2021_samps_df)
blma2021_samps_final


blma2021_lulc_cart <- rpart(as.factor(class)~., data = blma2021_samps_final, method = 'class', minsplit = 5)
print(blma2021_lulc_cart)
plot(blma2021_lulc_cart, uniform=TRUE, main="Classification Tree")
text(blma2021_lulc_cart, cex = 1)

blma2021_lulc_class <- predict(blma2021_b543, blma2021_lulc_cart, na.rm = TRUE)
blma2021_lulc_class
plot(blma2021_lulc_class)

blma2021_lulc <- which.max(blma2021_lulc_class)
plot(blma2021_lulc)

classes_4 <- c("built_bare", "dense_veg", "sparse_veg", "water")
classes_5 <- c("built_bare", "dense_veg", "sparse_veg", "water", "wetland")
lulc_df <- data.frame(id = 1:4, class = classes_4)
levels(blma2021_lulc) <- lulc_df
blma2021_lulc
plot(blma2021_lulc, col = lulc_colors_4)
lulc_df
# model evaluation

set.seed(99)

j <- kfold(blma2021_samps_final, k = 5, by = blma2021_samps_final$class)
table(j)

acc <- list()

for (k in 1:5) {
  train <- blma2021_samps_final[j!= k, ]
  test <- blma2021_samps_final[j == k, ]
  cart <- rpart(as.factor(class)~., data=train, method = 'class', minsplit = 5)
  pclass <- predict(cart, test, na.rm = TRUE) 
  pclass <- apply(pclass, 1, which.max)
  acc[[k]] <- cbind(test$class, as.integer(pclass))
}

acc_5 <- do.call(rbind, acc)
acc_5 <- data.frame(acc_5)
colnames(acc_5) <- c('observed', 'predicted')

confmat <- table(acc_5)
colnames(confmat) <- lulc_df$class
print(confmat)

blma2021_cases <- sum(confmat)
blma2021_true_cases <- diag(confmat)
blma2021_overall_acc <- sum(blma2021_true_cases)/blma2021_cases


blma2021_rowsums <- apply(confmat, 1, sum)
blma2021_rowsums_obs <- blma2021_rowsums/blma2021_cases

blma2021_colsums <- apply(confmat, 2, sum)
blma2021_colsums_prd <- blma2021_colsums/blma2021_cases

blma2021_expAcc <- sum(blma2021_rowsums_obs*blma2021_colsums_prd)
blma2021_kappa <- (blma2021_overall_acc - blma2021_expAcc)/(1 - blma2021_expAcc)
blma2021_kappa

blma2021_ProdAcc <- blma2021_true_cases/blma2021_colsums
blma2021_UserAcc <- blma2021_true_cases/blma2021_rowsums

blma2021_outAcc <- data.frame(producerAccuracy = blma2021_ProdAcc, userAccuracy = blma2021_UserAcc)
blma2021_outAcc 

# i don't trust these accuracies. They are completely dependent on the 
# groundtruth/reference data so if that is wrong, so are the accuracies. 
# i know for sure built-bare is currently wrongly classified as sparse veg.
# see GEE script from Simon.
```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent
printing of the R code that generated the plot.
